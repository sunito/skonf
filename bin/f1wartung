#!/bin/bash

logger "FFFFFFFFFFFFFF start"
echo 
echo " Für die Fervwartung dieses Computers bitte Sven anrufen: +49-39881-49194 oder +43-720-514378"
echo " Oder mailen: fernwart123@suska.org "
echo

c=s
cmd=$c${c}h
user_file=$HOME/.$cmd/fernwartung/user

if [[ $1 == "--init" ]] ;then
  echo "Installiere" 
  mkdir -p $(dirname "$user_file")
  echo -n "user name: "
  read user
  [ x$user == x ] && echo "Abbruch, da keine Eingabe" && exit 3 
  echo $user >"$user_file"
  
  echo "Lade Schlüssel hoch"
  ${cmd}-copy-id $user@suska.org
  exit 1
fi

if ! [[ -f "$user_file" ]] ;then
  echo "Die Fernwartung ist noch nicht installiert." 
  echo
  echo "Bitte Enter drücken"
  read dummy
  sleep 1
  exit 4
fi

echo -n "    <info:"
echo -n $cmd"-"
user=`cat $user_file`
echo -n $user"-"

port=`grep "Port " /etc/$cmd/${cmd}d_config |cut -d" " -f2`
echo -n $port

echo -n "-"

caller_base=$(basename $0)
digit=${caller_base:1:1}
if [[ ! $digit =~ [0-9] ]]  ;then 
  digit=0
fi
echo -n $digit

echo -n "-"

ownport=$((10${digit}40 + `id -u`))
echo -n $ownport
echo ">  "






logger "FFFFFFFFFFFFFF c$cmd o$ownport p$port u$user"
#echo 
#echo "Starte Ferwartungs-Konsole" 

execute="$cmd -R $ownport:127.0.0.1:$port $user@suska.org"

logger "FFFFFFFFFFFFFF vor execute"
logger "FFFFFF $execute"
echo
echo "Verbinde mit Server"
echo $execute
$execute
logger "FFFFFFFFFFFFFFFFFFFFFFFFFFFFF fertig"

